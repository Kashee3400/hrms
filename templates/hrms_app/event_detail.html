{% extends 'hrms_app/base.html' %}
{% load static hrms_tag humanize i18n %}

{% block title %}
  {{ user }} | {{ object.title }}
{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'hrms_app/css/event_detail.css' %}">
{% endblock %}

{% block content %}
  <div class="breadcrumb-section">
    <div class="container-fluid">
      {% render_breadcrumb 'Attendance' urls %}
    </div>
  </div>

  <div class="container-fluid">
    <div class="page-title">
      <i class="bi bi-calendar-check"></i>
      <span>Attendance Details</span>
    </div>

    <div class="row">
      <!-- Attendance Details Card -->
      <div class="col-xl-6 col-lg-6 col-md-12 mb-4">
        <div class="enhanced-card">
          <div class="gradient-header">
            <i class="bi bi-clock-history"></i>
            <span>{{ object.title }}</span>
          </div>
          <div class="card-body p-0">
            <ul class="attendance-list">
              <li class="attendance-item">
                <span class="attendance-label">
                  <i class="bi bi-box-arrow-in-right"></i>
                  Login Time
                </span>
                <span class="status-badge badge-info">
                  {% if attendance_data.has_history %}
                    {{ attendance_data.login_time|str_to_date }}
                  {% else %}
                    {{ attendance_data.login_time }}
                  {% endif %}
                </span>
              </li>
              <li class="attendance-item">
                <span class="attendance-label">
                  <i class="bi bi-box-arrow-right"></i>
                  Logout Time
                </span>
                <span class="status-badge badge-info">
                  {% if attendance_data.has_history %}
                    {{ attendance_data.logout_time|str_to_date }}
                  {% else %}
                    {{ attendance_data.logout_time }}
                  {% endif %}
                </span>
              </li>
              <li class="attendance-item">
                <span class="attendance-label">
                  <i class="bi bi-hourglass-split"></i>
                  Working Hours
                </span>
                <span class="status-badge badge-secondary">{{ attendance_data.working_hours }}</span>
              </li>
              <li class="attendance-item">
                <span class="attendance-label">
                  <i class="bi bi-check-circle"></i>
                  Status
                </span>
                <span class="status-badge badge-success status-indicator {{ attendance_data.status }}">
                  {{ attendance_data.status|upper }}
                </span>
              </li>
              {% if attendance_data.has_history and attendance_data.regularized_info %}
                <li class="attendance-item">
                  <span class="attendance-label">
                    <i class="bi bi-arrow-clockwise"></i>
                    Regularized
                  </span>
                  <span class="status-badge badge-warning">
                    {{ attendance_data.regularized_info.from_time|str_to_date|time }} - 
                    {{ attendance_data.regularized_info.to_time|str_to_date|time }} 
                    ({{ attendance_data.regularized_info.duration }})
                  </span>
                </li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Follow Ups Section -->
      {% if object.actions %}
        <div class="col-xl-6 col-lg-6 col-md-12 mb-4">
          {% if object.actions.all %}
            <div class="accordion follow-ups-accordion" id="followUpsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="followUpsHeader">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                          data-bs-target="#followUpsCollapse" aria-expanded="true" aria-controls="followUpsCollapse">
                    <i class="bi bi-chat-dots me-2"></i>
                    Follow Ups ({{ object.actions.all|length }})
                  </button>
                </h2>
                <div id="followUpsCollapse" class="accordion-collapse collapse show" aria-labelledby="followUpsHeader">
                  <div class="accordion-body">
                    {% for log in object.actions.all|dictsortreversed:'timestamp' %}
                      <div class="follow-up-item">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <strong class="text-primary {{ log.action }}">
                              <i class="bi bi-person-check me-1"></i>
                              {{ log.action|capfirst }}
                            </strong>
                            <div class="text-muted small mt-1">
                              by {{ log.action_by_name }}
                            </div>
                          </div>
                          <span class="badge bg-light text-dark">
                            {{ log.timestamp|timesince }} ago
                          </span>
                        </div>
                      </div>
                    {% empty %}
                      <div class="text-center py-4 text-muted">
                        <i class="bi bi-inbox display-4"></i>
                        <p class="mt-2">No follow-ups available</p>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <div class="enhanced-card">
              <div class="card-body text-center py-5">
                <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                <h5 class="mt-3 text-danger">{% trans 'No Follow ups' %}</h5>
              </div>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Regularization Form Section -->
    {% if show_regularization_form %}
      <div class="row">
        <div class="col-12 mb-4">
          <div class="enhanced-card regularization-form-card">
            <div class="gradient-header">
              <i class="bi bi-pencil-square"></i>
              <span>{{ object.reg_status|capfirst }}</span>
              <div class="ms-auto">
                <span class="badge bg-warning bg-opacity-20 text-white border border-warning">
                  {{ regularization_month_warning }}
                </span>
              </div>
            </div>
            
            <div class="card-body">
              <form id="reg-application-form" method="post">
                {% csrf_token %}

                <!-- Display Non-Field Errors -->
                {% if form.non_field_errors %}
                  <div class="alert alert-danger border-0 rounded-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-exclamation-triangle-fill me-2"></i>
                      <strong>Error!</strong>
                    </div>
                    <ul class="mb-0 mt-2">
                      {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                <div class="row g-4">
                  {% for field in form %}
                    <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12">
                      <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                          {{ field.label }}
                          {% if field.field.required %}
                            <span class="text-danger">*</span>
                          {% endif %}
                        </label>
                        {{ field }}

                        <!-- Field-Specific Errors -->
                        {% if field.errors %}
                          <div class="invalid-feedback d-block">
                            <ul class="mb-0 list-unstyled">
                              {% for error in field.errors %}
                                <li><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</li>
                              {% endfor %}
                            </ul>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>

                {% if object.is_submitted %}
                  <div class="alert alert-success border-0 rounded-3 mt-4">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-check-circle-fill me-2"></i>
                      <span class="fw-semibold">Application Submitted Successfully</span>
                    </div>
                  </div>
                {% endif %}
              </form>
            </div>

            <!-- Submit Button Section -->
            {% if user_permissions.can_submit_regularization %}
              <div class="card-footer border-0 bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Please review all details before submitting
                  </div>
                  <button type="button" class="btn btn-enhanced btn-primary-enhanced" 
                          data-bs-toggle="modal" data-bs-target="#updateDialog">
                    <i class="bi bi-send me-2"></i>
                    Submit For Regularization
                  </button>
                </div>
              </div>
            {% endif %}

            <!-- Action Buttons Section -->
            {% if user_permissions.can_take_action %}
              <div class="card-footer border-0 bg-light bg-opacity-50">
                <form id="action-form" method="post" action="{% url 'attendance_log_action' slug=object.slug %}">
                  {% csrf_token %}
                  {{ action_form.as_p }}
                  
                  <div class="d-flex gap-2 flex-wrap">
                    <span class="fw-semibold text-muted me-3 align-self-center">Take Action:</span>
                    {% for action in user_permissions.available_actions %}
                      <button type="button" name="action" value="{{ action.name }}" 
                              class="btn btn-enhanced {{ action.class }}-enhanced action-btn" 
                              data-bs-toggle="modal" data-bs-target="#actionDialog" 
                              data-action="{{ action.name }}">
                        {% if action.name == 'approve' %}
                          <i class="bi bi-check-lg me-1"></i>
                        {% elif action.name == 'reject' %}
                          <i class="bi bi-x-lg me-1"></i>
                        {% elif action.name == 'recommend' %}
                          <i class="bi bi-hand-thumbs-up me-1"></i>
                        {% else %}
                          <i class="bi bi-hand-thumbs-down me-1"></i>
                        {% endif %}
                        {{ action.label }}
                      </button>
                    {% endfor %}
                  </div>
                </form>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Floating Action Button for Quick Actions -->
  <button type="button" class="floating-action-btn d-lg-none" data-bs-toggle="offcanvas" 
          data-bs-target="#quickActionsOffcanvas" aria-controls="quickActionsOffcanvas">
    <i class="bi bi-three-dots"></i>
  </button>

  <!-- Update Modal -->
  <div class="modal fade" id="updateDialog" tabindex="-1" aria-labelledby="updateDialogLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateDialogLabel">
            <i class="bi bi-question-circle me-2"></i>
            {% trans 'Confirm Submission' %}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center py-3">
            <i class="bi bi-exclamation-triangle display-6 text-warning"></i>
            <h6 class="mt-3">Are you sure you want to submit?</h6>
            <p class="text-muted">
              You want to update the <strong>{{ object.reg_status|upper }}</strong> duration 
              <strong>{{ object.reg_duration }}</strong>
            </p>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">
            <i class="bi bi-x-lg me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-enhanced btn-primary-enhanced" onclick="submitForm()">
            <i class="bi bi-check-lg me-1"></i>Submit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Modal -->
  <div class="modal fade" id="actionDialog" tabindex="-1" aria-labelledby="actionDialogLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="actionDialogLabel">
            <i class="bi bi-shield-check me-2"></i>
            {% trans 'Confirm Action' %}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center py-3">
            <i class="bi bi-question-circle display-6 text-primary"></i>
            <h6 class="mt-3" id="action-message">Confirm your action</h6>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">
            <i class="bi bi-x-lg me-1"></i>{% trans 'Cancel' %}
          </button>
          <button type="button" class="btn btn-enhanced btn-primary-enhanced" id="confirm-action-btn">
            <i class="bi bi-check-lg me-1"></i>{% trans 'Confirm' %}
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ late_coming|json_script:'late-coming-data' }}
  {{ early_going|json_script:'early-going-data' }}

  <script src="{% static 'hrms_app/js/attendance_log.js' %}"></script>
  <script>
    function submitForm() {
      // Add loading state
      const submitBtn = document.querySelector('#updateDialog .btn-primary-enhanced');
      const originalContent = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Submitting...';
      submitBtn.disabled = true;
      
      // Submit form
      document.getElementById('reg-application-form').submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('action-form');
      const actionMessage = document.getElementById('action-message');
      const confirmActionBtn = document.getElementById('confirm-action-btn');
      let selectedAction = '';
      
      // Enhanced action button handling
      document.querySelectorAll('.action-btn').forEach((button) => {
        button.addEventListener('click', function () {
          selectedAction = this.getAttribute('data-action');
          const actionText = this.textContent.trim();
          
          // Update modal content based on action
          let icon = '';
          let color = '';
          switch(selectedAction) {
            case 'approve':
              icon = 'bi-check-circle-fill';
              color = 'text-success';
              break;
            case 'reject':
              icon = 'bi-x-circle-fill';
              color = 'text-danger';
              break;
            case 'recommend':
              icon = 'bi-hand-thumbs-up-fill';
              color = 'text-success';
              break;
            default:
              icon = 'bi-hand-thumbs-down-fill';
              color = 'text-warning';
          }
          
          document.querySelector('#actionDialog .display-6').className = `bi ${icon} display-6 ${color}`;
          actionMessage.textContent = `Are you sure you want to ${actionText.toLowerCase()} the duration {{ object.reg_duration }}?`;
        });
      });
    
      // Enhanced confirmation handling
      confirmActionBtn.addEventListener('click', function () {
        // Add loading state
        const originalContent = this.innerHTML;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing...';
        this.disabled = true;
        
        // Create and submit form
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = selectedAction;
        form.appendChild(actionInput);
        form.submit();
      });

      // Auto-hide alerts after 5 seconds
      setTimeout(function() {
        document.querySelectorAll('.alert').forEach(function(alert) {
          if (alert.classList.contains('alert-success')) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
          }
        });
      }, 5000);
    });
  </script>
{% endblock %}