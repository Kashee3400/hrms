{% extends 'hrms_app/base.html' %}
{% load static hrms_tag i18n %}
{{ form.media }}
{% block title %}
{{ request.user.get_short_name }} | {{ title }}
{% endblock %}
{% block extrastyle %}
<link rel="stylesheet" href="{% static 'js/select.dataTables.min.css' %}" />
<link rel="stylesheet" href="{% static 'hrms_app/css/home.css' %}" />

{% endblock %}

{% block content %}
<div class="py-4">

  <div class="row g-4 mb-4">

    <div class="col-12 col-xl-5">
      <div class="dashboard-card h-100">
        <div class="card-header-clean">
          <div>
            <span class="text-muted small d-block mb-1">{{ current_date }}</span>
            <h5 class="mb-0">{% trans "Hello," %} {{ request.user.first_name }}! ðŸ‘‹</h5>
          </div>
          <span class="badge bg-light text-dark border">
            <i class="mdi mdi-clock-outline me-1"></i> {{ request.user.shifts.first|default:"General Shift" }}
          </span>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-4">
            "{% trans "Every great day starts with a single punch. Let's make today count!" %}"
          </p>

          <div class="row g-3">
            <div class="col-4">
              <div class="stat-box" style="background: var(--success-soft); border-color: var(--success-soft);">
                <i class="fas fa-sign-in-alt text-success mb-2"></i>
                <div class="label text-success-emphasis">{% trans 'In' %}</div>
                <div class="value text-success">{{ check_in_time|default:"--" }}</div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-box" style="background: var(--warning-soft); border-color: var(--warning-soft);">
                <i class="fas fa-sign-out-alt text-warning mb-2"></i>
                <div class="label text-warning-emphasis">{% trans 'Out' %}</div>
                <div class="value text-warning">{{ check_out_time|default:"--" }}</div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-box" style="background: var(--info-soft); border-color: var(--info-soft);">
                <i class="fas fa-hourglass-half text-info mb-2"></i>
                <div class="label text-info-emphasis">{% trans 'Hrs' %}</div>
                <div class="value text-info pulse">{{ total_hours|default:"00:00" }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-7">
      <div class="row g-4 h-100">

        {% if request.user.is_rm or request.user.is_superuser %}
        <div class="col-12">
          <div class="dashboard-card">
            <div class="card-header-clean text-danger">
              {% trans 'Needs Your Approval' %}
              <span class="badge bg-danger rounded-pill">{{ count_list|length }}</span>
            </div>
            <div class="card-body my-2">
              {% if count_list %}
              <div class="horizontal-scroll-wrapper">
                {% for item in count_list %}
                <a href="{{ item.link }}" class="text-decoration-none text-dark">
                  <div class="request-card">
                    <i class="{{ item.icon }} text-danger fs-4 mb-2"></i>
                    <div class="small fw-bold text-truncate" style="max-width: 100px;">{{ item.title }}</div>
                    <div class="h4 mb-0 mt-1">{{ item.count }}</div>
                  </div>
                </a>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-center text-muted py-3">
                <i class="mdi mdi-check-circle-outline fs-3 text-success"></i>
                <p class="mb-0 small">{% trans "All caught up! No pending approvals." %}</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">

    {% if request.user.employees.exists %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="dashboard-card h-100">
        <div class="card-header-clean">
          {% trans 'My Team' %}
          <span class="badge bg-primary rounded-pill">{{ request.user.employees.count }}</span>
        </div>
        <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
          {% for user in request.user.employees.all %}
          <div class="avatar-list-item d-flex align-items-center">
            <img
              src="{% if user.personal_detail.avatar %}{{ user.personal_detail.get_avatar_url }}{% else %}{% static 'source/images/user1-128x128.jpg' %}{% endif %}"
              class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
            <div class="overflow-hidden">
              <h6 class="mb-0 text-truncate" style="font-size: 0.9rem;">{{ user.get_full_name }}</h6>
              <small class="text-muted text-truncate d-block" style="font-size: 0.75rem;">
                {{ user.personal_detail.designation|default:"Employee" }}
              </small>
            </div>
            <a href="#" class="ms-auto btn btn-sm btn-light rounded-circle" title="View Profile"><i
                class="mdi mdi-chevron-right"></i></a>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="col-12 col-md-8 {% if request.user.employees.exists %}col-lg-4{% else %}col-lg-8{% endif %}">
      <div class="dashboard-card">
        <div class="card-header-clean text-primary">
          {% trans 'My Request Status' %}
        </div>
        <div class="card-body">
          <div class="horizontal-scroll-wrapper">
            {% user_summary_counts %}
          </div>
        </div>
        <div class="px-3">
          {% get_leave_balances request.user request %}

        </div>
      </div>
    </div>


    <div class="col-12 col-md-12 col-lg-4">
      <div class="dashboard-card">
        <div class="card-header-clean text-warning">
          <i class="fas fa-umbrella-beach me-2"></i> {% trans 'Upcoming Holidays' %}
        </div>
        <div class="card-body p-0">
          {% get_holidays %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="dashboard-card">
        <div class="card-header-clean">
          {% trans 'Monthly Attendance Overview' %}
        </div>
        <div class="card-body p-3">
          <div class="table-responsive" style="max-height: 500px;">
            <table class="table table-hover table-striped mb-0 attendance-table">
              <thead>
                <tr>
                  <th class="sticky-col text-dark" style="min-width: 80px;">Code</th>
                  <th class="sticky-col-2 text-dark" style="min-width: 150px; text-align: left;">Employee Name</th>
                  {% for day in days_in_month %}
                  <th style="min-width: 50px;">
                    {{ day|date:'d' }}<br>
                    <span style="font-weight: 400; font-size: 0.65rem;">{{ day|date:'D' }}</span>
                  </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for employee in employees %}
                <tr>
                  <td class="sticky-col fw-bold text-muted">
                    {% format_emp_code employee.personal_detail.employee_code %}
                  </td>
                  <td class="sticky-col-2 text-start fw-bold text-primary">
                    {{ employee.get_full_name }}
                  </td>
                  {% for mdate in days_in_month %}
                  <td>
                    {% get_item attendance_data employee.id mdate as statuses %}
                    {% for status in statuses %}
                    <span class="badge rounded-pill"
                      style="background-color: {{ status.color }}20; color: {{ status.color }}; border: 1px solid {{ status.color }}50; font-weight: 600; font-size: 0.7rem;">
                      {{ status.status }}
                    </span>
                    {% empty %}
                    <span class="text-muted">-</span>
                    {% endfor %}
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock %}


{% block extra_js %}
<script>
  $(document).ready(function () {
    $('.table').DataTable({
      paging: true,
      searching: true,
      ordering: false,
      dom: 'Bfrtip',
      buttons: [],
      pageLength: 25,
      lengthMenu: [10, 25, 50, 100]
    })
  })
</script>
{% endblock %}